# =============================================================================
# EXAMPLE 7: SECURITY & CODE QUALITY SCANNING
# =============================================================================
# Use Case: Automated security vulnerability and code quality checks
# Perfect for: any production application, compliance requirements
# =============================================================================

name: Security & Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # Run weekly security scan
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight

jobs:
  # -------------------------------------------------------------------------
  # JOB 1: CODE QUALITY
  # Static analysis and linting
  # -------------------------------------------------------------------------
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install flake8 black isort mypy

      # -----------------------------------------------------------------------
      # FLAKE8 - Style Guide Enforcement
      # -----------------------------------------------------------------------
      - name: Run flake8 (PEP8 style check)
        run: |
          flake8 src/ tests/ --max-line-length=100 --statistics
        continue-on-error: true

      # -----------------------------------------------------------------------
      # BLACK - Code Formatting Check
      # -----------------------------------------------------------------------
      - name: Check formatting with Black
        run: |
          black --check --diff src/ tests/
        continue-on-error: true

      # -----------------------------------------------------------------------
      # ISORT - Import Sorting Check
      # -----------------------------------------------------------------------
      - name: Check import sorting
        run: |
          isort --check-only --diff src/ tests/
        continue-on-error: true

      # -----------------------------------------------------------------------
      # MYPY - Type Checking
      # -----------------------------------------------------------------------
      - name: Run type checking with mypy
        run: |
          mypy src/ --ignore-missing-imports
        continue-on-error: true

  # -------------------------------------------------------------------------
  # JOB 2: DEPENDENCY SECURITY SCAN
  # Check for known vulnerabilities in dependencies
  # -------------------------------------------------------------------------
  dependency-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -----------------------------------------------------------------------
      # PIP-AUDIT - Vulnerability Scanner
      # Checks dependencies against known vulnerability databases
      # -----------------------------------------------------------------------
      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          pip install -r requirements.txt
          pip-audit --desc
        continue-on-error: true

      # -----------------------------------------------------------------------
      # SAFETY - Alternative Security Scanner
      # -----------------------------------------------------------------------
      - name: Install safety
        run: pip install safety

      - name: Run safety check
        run: |
          safety check -r requirements.txt --full-report
        continue-on-error: true

  # -------------------------------------------------------------------------
  # JOB 3: SECRET SCANNING
  # Detect accidentally committed secrets/credentials
  # -------------------------------------------------------------------------
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for thorough scanning

      # -----------------------------------------------------------------------
      # GITLEAKS - Secret Detection
      # Scans for API keys, passwords, tokens, etc.
      # -----------------------------------------------------------------------
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # -------------------------------------------------------------------------
  # JOB 4: SAST (Static Application Security Testing)
  # Analyze code for security vulnerabilities
  # -------------------------------------------------------------------------
  sast-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -----------------------------------------------------------------------
      # BANDIT - Python Security Linter
      # Finds common security issues in Python code
      # -----------------------------------------------------------------------
      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit security scan
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
        if: always()


